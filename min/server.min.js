var express=require("express"),fs=require("fs"),passport=require("passport"),FacebookStrategy=require("passport-facebook").Strategy,mongoose=require("mongoose"),compass=require("compass"),Schema=mongoose.Schema;mongoose.connect(process.env.MONGOHQ_URL);var app=express();app.configure(function(){app.use(express.static("public")),app.use(express.cookieParser()),app.use(express.bodyParser()),app.use(express.session({secret:process.env.SUPER_SECRET_SESSIONS_KEY})),app.use(passport.initialize()),app.use(passport.session()),app.use(app.router)}),passport.use(new FacebookStrategy({clientID:process.env.FACEBOOK_APP_ID,clientSecret:process.env.FACEBOOK_APP_SECRET,callbackURL:"http://energiesbalanced.herokuapp.com/auth/facebook/callback"},function(e,s,o,r){r(null,o)}));var userSchema=new Schema({facebook_id:String,first_name:String,last_name:String,fb_username:String,time_created:Date}),User=mongoose.model("User",userSchema);User.create=function(e){var s={facebook_id:e.id,first_name:e.name.givenName,last_name:e.name.familyName,fb_username:e.username,time_created:new Date},o=new User(s);o.save()},User.isuser=function(e){console.log(e);var s=User.find({facebook_id:e}).exec(function(e,s){return s});return console.log("this is the user returned"),console.log(s),s?s.facebook_id==e?!0:!1:!1},app.delete("/users/all",function(e,s){User.remove(function(e){return e?(console.log(e),void 0):(console.log("removed"),s.send(User.find({})))})}),app.get("/users",function(e,s){User.find({}).exec(function(e,o){s.send({users:o})})}),app.get("/users/:facebook_id",function(e,s){User.find({facebook_id:e.params.facebook_id}).exec(function(e,o){s.send({user:o})})}),passport.serializeUser(function(e,s){var o=User.isuser(e.id);o||User.create(e),s(null,e.id)}),passport.deserializeUser(function(e,s){s(null,e)}),app.get("/auth/facebook",passport.authenticate("facebook")),app.get("/auth/facebook/callback",passport.authenticate("facebook",{successRedirect:"/welcome/lisa",failureRedirect:"/"})),app.get("/logout",function(e,s){e.logout(),s.redirect("/")}),app.get("/session",function(e,s){s.send({session:e.session})}),app.use(express.logger()),app.use(express.static(__dirname+"/public"));var port=process.env.PORT||5e3;app.listen(port,function(){console.log("Listening on "+port)}),exports=module.exports=app;